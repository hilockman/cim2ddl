<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>分布式计算-节点配置</title>
    <meta charset="utf-8" />
    <div th:replace="fragments/header :: header-css">
    </div>
    <style>
		h4, .h4 {
		    font-size: 18px;
		}
    </style>
</head>
<body>



<div th:replace="fragments/header :: header">
</div>
<div class="container-fluid">

    <div id="table-body"> 

	    <div class="btn-group pull-right">
	       <a class="btn btn-success btn-sm" id="add-user-btn" th:href="@{/newnode}" >添加节点</a>
	    </div>
	     <h2 class="h4">节点列表</h2>     
       	
	    <table class="table">
	      <thead>
		       <tr>
		         <!-- th>id</th-->
		         <th>名称</th>
		         <th>状态</th>
		         <th>更新时间</th>	         
		         <th>执行任务次数</th>
		         <th>执行工作次数</th>
		         <th>操作</th>
		      </tr>     
	      </thead>
	      <tbody>
	          <tr class="gradeX" th:each="node : ${nodeList}">
			        <!--td th:text="${node.id}"></td-->
			        <td>
			            <a target="_blank" th:href="${node.url}" th:text="${node.name}" th:title="${node.url}">
			            </a>
			        </td>
			        <td th:text="${node.status}==1?'运行':'停运'">
			
			        </td>
			        <td th:text="${#dates.format(node.lastUpdate,'yyyy-MM-dd HH:mm:ss')}">2016-10-14 10:41:50</td>
			        <td th:text="${node.taskCount}"></td>		        
			        <td th:text="${node.jobCount}"></td>
			        <td th:data-id="${node.id}" th:data-state="${node.status}">
			            <button class="btn btn-primary btn-xs node-edit" type="button" title="编辑" >
			                编辑
			            </button>
			            <button class="btn btn-info btn-xs node-state" type="button" th:text="${node.status}!=1?'运行':'停运'" th:title="${node.status}!=1?'运行':'停运'">
			                停运
			            </button>
			
			            <button class="btn btn-danger btn-xs node-delete" type="button" title="删除" >
			                删除
			            </button>	
			        </td>
			  </tr>
	      </tbody>
	    </table>
           	
    </div>
     	


</div>
<!-- /.container -->

<div th:replace="fragments/footer :: footer">
</div>
 <script type="text/javascript">

 function str_repeat(i, m) {
	    for (var o = []; m > 0; o[--m] = i);
	    return o.join('');
	}

	function sprintf() {
	    var i = 0, a, f = arguments[i++], o = [], m, p, c, x, s = '';
	    while (f) {
	        if (m = /^[^\x25]+/.exec(f)) {
	            o.push(m[0]);
	        }
	        else if (m = /^\x25{2}/.exec(f)) {
	            o.push('%');
	        }
	        else if (m = /^\x25(?:(\d+)\$)?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(f)) {
	            if (((a = arguments[m[1] || i++]) == null) || (a == undefined)) {
	                throw('Too few arguments.');
	            }
	            if (/[^s]/.test(m[7]) && (typeof(a) != 'number')) {
	                throw('Expecting number but found ' + typeof(a));
	            }
	            switch (m[7]) {
	                case 'b': a = a.toString(2); break;
	                case 'c': a = String.fromCharCode(a); break;
	                case 'd': a = parseInt(a); break;
	                case 'e': a = m[6] ? a.toExponential(m[6]) : a.toExponential(); break;
	                case 'f': a = m[6] ? parseFloat(a).toFixed(m[6]) : parseFloat(a); break;
	                case 'o': a = a.toString(8); break;
	                case 's': a = ((a = String(a)) && m[6] ? a.substring(0, m[6]) : a); break;
	                case 'u': a = Math.abs(a); break;
	                case 'x': a = a.toString(16); break;
	                case 'X': a = a.toString(16).toUpperCase(); break;
	            }
	            a = (/[def]/.test(m[7]) && m[2] && a >= 0 ? '+'+ a : a);
	            c = m[3] ? m[3] == '0' ? '0' : m[3].charAt(1) : ' ';
	            x = m[5] - String(a).length - s.length;
	            p = m[5] ? str_repeat(c, x) : '';
	            o.push(s + (m[4] ? a + p : p + a));
	        }
	        else {
	            throw('Huh ?!');
	        }
	        f = f.substring(m[0].length);
	    }
	    return o.join('');
	}
	
	function NodeFunction() {
		this.baseUrl = 'node/';
		this.getNodes = function(callBack, failCallBack) { return this.query('all', callBack, failCallBack);};
	}  
	
	NodeFunction.prototype.query =  function (url, callBack, failCallBack) {
		     var result;
		     
			 jQuery.ajax({
			        url: this.baseUrl+url,
			        success: callBack != undefined ? callBack : function(record) { result = record; },
			        async: callBack == undefined ? false : true,
			        error: failCallBack				        
			    });
			 
			 
			 if (callBack == undefined) {
				 return result;
			 }
	};	
	
	var nodeApi = new NodeFunction();
	
	// 对Date的扩展，将 Date 转化为指定格式的String
	// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符， 
	// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字) 
	// 例子： 
	// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423 
	// (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18 
	Date.prototype.Format = function (fmt) { //author: meizz 
	    var o = {
	        "M+": this.getMonth() + 1, //月份 
	        "d+": this.getDate(), //日 
	        "h+": this.getHours(), //小时 
	        "H+": this.getHours(),
	        "m+": this.getMinutes(), //分 
	        "s+": this.getSeconds(), //秒 
	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
	        "S+": this.getMilliseconds() //毫秒 
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	       if (new RegExp("(" + k + ")").test(fmt)) {
	    	   var str = [];
	    	   for (var i = 0; i < RegExp.$1.length; i++) {
	    		   str.push('0');
	    	   }
	    	   
	    	   fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : ((str.join('') + o[k]).substr(("" + o[k]).length)));
	       }
	    return fmt;
	}
	
    function updateNodes(nodes) {
    	var tbody = $("table tbody");
    	tbody.children().remove();
    	var str = "";
    	//console.log(nodes.length);
    	
    	nodes.forEach(function(node) {
    		str += "<tr class='gradeX' >";
    		//str += sprintf("<td>%s</td>", node.id);
    		str += sprintf("<td><a target='_blank' href='%s' title='%s'>%s</a></td>", node.url, node.url, node.name);  	
    		
        	str += sprintf("<td><i class='fa fa-circle' style='color:%s' title='%s'> %s</i> </td>", (node.status == 1 ? 'green':'black')
        			, (node.status == 1 ? '运行':'停运'), (node.status == 1 ? '运行中':'已停运'));
       	    var dt = new Date(node.lastUpdate);
        	
        	str += sprintf("<td>%s</td>", dt.Format('yyyy-MM-dd HH:mm:ss.SSS'));
        	
        	
        	str += sprintf("<td>%s</td>",node.taskCount !=null && node.taskCount > 0 ? node.taskCount : '-' );
        	str += sprintf("<td>%s</td>",node.jobCount !=null && node.jobCount > 0 ? node.jobCount : '-' );
		    
        	str += sprintf("<td data-id='%s' data-state='%s'> "
		            +"<button class='btn btn-primary btn-xs node-edit' type='button' title='编辑' > 编辑 </button>"
		            +" <button class='btn btn-info btn-xs node-state' type='button'  title=%s> %s </button>"
		            +" <button class='btn btn-danger btn-xs node-delete' type='button' title='删除' > 删除 </button>"	
		        +"</td>", node.status, node.id, (node.status !=1 ? '运行':'停运'), (node.status !=1 ? '运行':'停运'));
		        
    		str += "</tr>";
    	});
      	
    	tbody.append(str);
    	
 		$(".node-delete").click(function () {
 			var id = $(this).parent().attr("data-id");
 			
  			$.ajax({
 				url : "node/delete/"+id,
 				type : "POST",
 				data : null,

 				success : function(msg) {
 					console.log(msg);
 					window.location.href ="/nodes";
 				},
 				error : function() {
 					alert("fail to delete node : id= "+ id);
 				}
 			});
 		});
    	
 		$(".node-edit").click(function() {
 			var id = $(this).parent().attr("data-id");
 			
 			window.location.href = "/node/edit/"+id;
			
 		});
    }
 	$(function () {
 		
 		setTimeout(function(){
 			nodeApi.getNodes(updateNodes);
 		}, 0);
 
 		
 		setInterval(function(){
 			nodeApi.getNodes(updateNodes);
 		}, 2000);
 		
 	});
 </script>
</body>
</html>